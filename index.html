<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HKDSE SQL æ¨¡æ“¬å­¸ç¿’å™¨ï½œæ­Œæ‰‹æ•¸æ“šåº«ï¼ˆçµ‚æ¥µå®Œæ•´ç‰ˆï¼‰</title>
<style>
*{box-sizing:border-box;font-family:Arial,"Microsoft JhengHei",sans-serif}
body{margin:10px;background:#f7f9fc}
.container{max-width:1200px;margin:auto}
.panel{background:white;border-radius:10px;padding:15px 20px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
h1{color:#222;margin:0 0 10px;font-size:22px}
h2{font-size:18px;color:#444;margin-bottom:8px}
.sql-input{width:100%;height:150px;padding:10px;font-size:15px;border:1px solid #ccc;border-radius:6px;resize:vertical}
.btn-run{background:#007bff;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin-top:8px;font-size:15px}
.btn-run:hover{background:#0069d9}
.btn-reset{background:#6c757d;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin-top:8px;margin-left:8px;font-size:15px}
.btn-reset:hover{background:#5a6268}
.error{color:#dc3545;font-weight:bold;margin:10px 0}
.success{color:#28a745;font-weight:bold;margin:10px 0}
.result-table{width:100%;border-collapse:collapse;margin-top:10px;overflow-x:auto;display:block}
.result-table th,.result-table td{border:1px solid #ddd;padding:8px;text-align:left;font-size:14px}
.result-table th{background:#f1f1f1}
.pre-code{background:#f8f9fa;padding:10px;border-radius:6px;overflow-x:auto;font-size:14px}
.dse-tips{background:#fff3cd;border-left:4px solid #ffc107;padding:10px;margin:10px 0;border-radius:4px}
@media (max-width: 768px) {
  .container{padding:0 10px}
  .panel{padding:10px 15px}
  h1{font-size:20px}
  h2{font-size:16px}
}
</style>
</head>
<body>
<div class="container">

<div class="panel">
<h1>HKDSE SQL æ¨¡æ“¬å­¸ç¿’å™¨ï¼ˆæ­Œæ‰‹æ•¸æ“šåº«ï¼‰ï½œçµ‚æ¥µå®Œæ•´ç‰ˆ</h1>
<p>âœ… å…§å»ºæ‰€æœ‰ DSE ICT æ•¸æ“šåº«å–®å…ƒå¿…è€ƒåŠŸèƒ½</p>
<div class="dse-tips">ğŸ’¡ <strong>DSE å‚™æˆ°è²¼å£«</strong>ï¼šè€ƒè©¦ä¸­å¸¸è€ƒã€ŒæŸ¥è©¢ + æ’åº + çµ±è¨ˆã€çš„çµ„åˆï¼Œä»¥åŠæ•¸æ“šä¿®æ”¹æ“ä½œã€‚è¨˜ä½æ‰€æœ‰é—œéµå­—çš„æ­£ç¢ºæ‹¼å¯«ï¼</div>
</div>

<div class="panel">
<h2>æ•¸æ“šåº«è¡¨æ ¼ï¼šsingersï¼ˆæ¬„ç›®æ¸…å–®ï¼‰</h2>
<div class="pre-code">
è—å (ä¸»éµ), æœ¬å, æ€§åˆ¥, å‡ºç”Ÿå¹´ä»½, å‡ºç”Ÿåœ°, è·æ¥­, å‡ºé“å¹´ä»½, ä¸»è¦èªè¨€, æ‰€å±¬å¹³å°/å» ç‰Œ, ç‹€æ…‹, ä»£è¡¨ä½œå“
</div>
<p>æ”¯æ´ï¼šSELECT / INSERT / UPDATE / DELETE / ORDER BY / GROUP BY / COUNT / DISTINCT / LIMIT / AS</p>
<textarea class="sql-input" id="sqlInput" placeholder="-- è¼¸å…¥ SQL æŒ‡ä»¤ï¼Œæ”¯æ´æ‰€æœ‰ DSE å¿…è€ƒèªæ³•
-- ç¯„ä¾‹ 1ï¼šæŸ¥è©¢
SELECT è—å, å‡ºé“å¹´ä»½ FROM singers WHERE æ€§åˆ¥='å¥³' ORDER BY å‡ºé“å¹´ä»½ DESC LIMIT 5

-- ç¯„ä¾‹ 2ï¼šæ–°å¢
INSERT INTO singers (è—å, æœ¬å, æ€§åˆ¥, å‡ºé“å¹´ä»½, æ‰€å±¬å¹³å°/å» ç‰Œ, ç‹€æ…‹) 
VALUES ('é™³å“è³¢','é™³å“è³¢','ç”·',2018,'MIRROR','æ´»èº')

-- ç¯„ä¾‹ 3ï¼šä¿®æ”¹
UPDATE singers SET ç‹€æ…‹='åŠé€€éš±' WHERE è—å='åŠ‰å¾·è¯'

-- ç¯„ä¾‹ 4ï¼šåˆªé™¤
DELETE FROM singers WHERE è—å='è©¦ç•¶çœŸ'

-- ç¯„ä¾‹ 5ï¼šçµ±è¨ˆ
SELECT æ‰€å±¬å¹³å°/å» ç‰Œ, COUNT(*) AS è—äººæ•¸é‡ FROM singers GROUP BY æ‰€å±¬å¹³å°/å» ç‰Œ"></textarea>
<br>
<button class="btn-run" onclick="runSQL()">åŸ·è¡Œ SQL</button>
<button class="btn-reset" onclick="resetData()">é‚„åŸåŸå§‹æ•¸æ“š</button>
</div>

<div class="panel">
<h2>éŒ¯èª¤æç¤ºï¼ˆå°æ‡‰ DSE è©•åˆ†æ¨™æº–ï¼‰</h2>
<div id="errorArea" class="error"></div>
</div>

<div class="panel">
<h2>æŸ¥è©¢çµæœ</h2>
<div id="resultArea"></div>
</div>

</div>

<script>
// ====================== åŸå§‹æ•¸æ“šå‚™ä»½ ======================
const backupData = [
["å¼µå­¸å‹","å¼µå­¸å‹","ç”·",1961,"é¦™æ¸¯","æ­Œæ‰‹ / æ¼”å“¡",1984,"ç²µèª","ç’°çƒå”±ç‰‡","æ´»èº","ã€Šå»åˆ¥ã€‹ã€Šä¸€è·¯ä¸Šæœ‰ä½ ã€‹"],
["é™³å¥•è¿…","é™³å¥•è¿…","ç”·",1974,"é¦™æ¸¯","æ­Œæ‰‹ / æ¼”å“¡",1995,"ç²µèª","ç’°çƒå”±ç‰‡","æ´»èº","ã€ŠKæ­Œä¹‹ç‹ã€‹ã€Šåå¹´ã€‹"],
["æ¢…è‰·èŠ³","æ¢…è‰·èŠ³","å¥³",1963,"é¦™æ¸¯","æ­Œæ‰‹ / æ¼”å“¡",1982,"ç²µèª","è¯æ˜Ÿå”±ç‰‡","å·²æ•…","ã€Šå¥³äººèŠ±ã€‹ã€Šå£å¥³å­©ã€‹"],
["å¼µåœ‹æ¦®","å¼µåœ‹æ¦®","ç”·",1956,"é¦™æ¸¯","æ­Œæ‰‹ / æ¼”å“¡",1985,"ç²µèª","è¯æ˜Ÿå”±ç‰‡","å·²æ•…","ã€Šæ²‰é»˜æ˜¯é‡‘ã€‹ã€Šç”·äººå“­å§ä¸æ˜¯ç½ªã€‹"],
["åŠ‰å¾·è¯","åŠ‰ç¦æ¦®","ç”·",1961,"é¦™æ¸¯","æ­Œæ‰‹ / æ¼”å“¡",1999,"ç²µèª","å¯°äºéŸ³æ¨‚","æ´»èº","ã€Šå¿˜æƒ…æ°´ã€‹ã€Šå¿ƒç¶“ã€‹"],
["å®¹ç¥–å…’","å®¹ç¥–å…’","å¥³",1980,"é¦™æ¸¯","æ­Œæ‰‹",1999,"ç²µèª","è‹±çš‡å¨›æ¨‚","æ´»èº","ã€Šç¿’æ…£å¤±æˆ€ã€‹ã€Šå¿ƒæ·¡ã€‹"],
["è¬å®‰çª","è¬å®‰çª","å¥³",1977,"é¦™æ¸¯","æ­Œæ‰‹",2005,"ç²µèª","æ–°è—å¯¶å”±ç‰‡","æ´»èº","ã€Šå–œå¸–è¡—ã€‹ã€Šé¾ç„¡è‰·ã€‹"],
["å¼µæ•¬è»’","å¼µæ•¬è»’","ç”·",1981,"å»£å·","æ­Œæ‰‹",2002,"ç²µèª","è‹±çš‡å¨›æ¨‚","æ´»èº","ã€Šé…·æ„›ã€‹ã€Šæ«»èŠ±æ¨¹ä¸‹ã€‹"],
["è¨±å»·é—","è¨±å»·é—","ç”·",1988,"é¦™æ¸¯","æ­Œæ‰‹",2010,"ç²µèª","æ˜Ÿå¤¢å¨›æ¨‚","æ´»èº","ã€Šé¢å…·ã€‹ã€Šé’æ˜¥é Œã€‹"],
["é™³æŸå®‡","é™³æŸå®‡","ç”·",1983,"é¦™æ¸¯","æ­Œæ‰‹",2007,"ç²µèª","Sony Music","æ´»èº","ã€Šä½ çæˆ‘çã€‹ã€Šé€¸å¾Œã€‹"],
["æ—å®¶è¬™","æ—å®¶è¬™","ç”·",1991,"é¦™æ¸¯","æ­Œæ‰‹ / éŸ³æ¨‚è£½ä½œäºº",2019,"ç²µèª","Terence Lam Production","æ´»èº","ã€Šä¸‹ä¸€ä½å‰åº¦ã€‹ã€Šä¸€äººä¹‹å¢ƒã€‹"],
["å§œæ¿¤","å§œæ¿¤","ç”·",1999,"é¦™æ¸¯","æ­Œæ‰‹ / æ¼”å“¡",2018,"ç²µèª","MIRROR","æ´»èº","ã€Šè’™ç€å˜´èªªæ„›ä½ ã€‹ã€ŠMaster Classã€‹"],
["å‘‚çˆµå®‰","å‘‚çˆµå®‰","ç”·",1997,"é¦™æ¸¯","æ­Œæ‰‹ / æ¼”å“¡",2018,"ç²µèª","MIRROR","æ´»èº","ã€ŠEå…ˆç”Ÿ é€£ç’°ä¸å¹¸äº‹ä»¶ã€‹ã€ŠWe All Areã€‹"],
["ç›§ç€šéœ†","ç›§ç€šéœ†","ç”·",1995,"é¦™æ¸¯","æ­Œæ‰‹ / æ¼”å“¡",2018,"ç²µèª","MIRROR","æ´»èº","ã€ŠMegahitã€‹ã€Šä¸å¯æ„›æ•™ä¸»ã€‹"],
["é™³è•¾","é™³è•¾","å¥³",1990,"é¦™æ¸¯","æ­Œæ‰‹",2016,"ç²µèª","ç’°çƒå”±ç‰‡","æ´»èº","ã€Šå‡¡æ˜Ÿã€‹ã€Šä¸–ç•Œèˆ‡ä½ ç„¡é—œã€‹"],
["COLLAR","NULL","å¥³åœ˜",null,"é¦™æ¸¯","æ­Œæ‰‹",2021,"ç²µèª","MakerVille","æ´»èº","ã€ŠCall My Name!ã€‹ã€ŠNever-never Landã€‹"],
["ç‚æ˜ç†¹","ç‹ä½³æ©","å¥³",2005,"é¦™æ¸¯","æ­Œæ‰‹",2021,"ç²µèª","TVB Music Group","æ´»èº","ã€ŠçœŸè¯çš„æ¸…é«˜ã€‹ã€Šå¤æ‚ã€‹"],
["å§šç„¯è²","å§šç„¯è²","å¥³",2006,"é¦™æ¸¯","æ­Œæ‰‹",2021,"ç²µèª","TVB Music Group","æ´»èº","ã€ŠåŸæ¥è°ˆæ‹çˆ±æ˜¯è¿™ä¹ˆä¸€å›äº‹ã€‹"],
["é¾æŸ”ç¾","é¾æŸ”ç¾","å¥³",2007,"é¦™æ¸¯","æ­Œæ‰‹",2021,"ç²µèª","TVB Music Group","æ´»èº","ã€ŠBreakin' My Heartã€‹"],
["è©¦ç•¶çœŸ","NULL","åœ˜é«”",null,"é¦™æ¸¯","ç¶²çµ¡å‰µä½œ / è—äºº",2020,"ç²µèª","YouTube","æ´»èº","ã€Šè©¦ç•¶çœŸã€‹ç¯€ç›®ç³»åˆ—"]
];

const columns = [
"è—å","æœ¬å","æ€§åˆ¥","å‡ºç”Ÿå¹´ä»½","å‡ºç”Ÿåœ°","è·æ¥­","å‡ºé“å¹´ä»½",
"ä¸»è¦èªè¨€","æ‰€å±¬å¹³å°/å» ç‰Œ","ç‹€æ…‹","ä»£è¡¨ä½œå“"
];

// å·¥ä½œæ•¸æ“šï¼ˆå¯ä¿®æ”¹ï¼‰
let dbData = [...backupData];

// ====================== é‡ç½®æ•¸æ“š ======================
function resetData() {
  dbData = [...backupData];
  document.getElementById("errorArea").innerHTML = "";
  document.getElementById("resultArea").innerHTML = "<p class='success'>âœ… æ•¸æ“šå·²é‚„åŸåˆ°åˆå§‹ç‹€æ…‹</p>";
}

// ====================== SQL è§£æèˆ‡åŸ·è¡Œæ ¸å¿ƒ ======================
function runSQL() {
  let sql = document.getElementById("sqlInput").value.trim();
  let err = document.getElementById("errorArea");
  let res = document.getElementById("resultArea");
  err.innerHTML = "";
  res.innerHTML = "";

  // æ¸…é™¤è¨»é‡‹
  sql = sql.replace(/--.*$/gm, '').trim();
  if (!sql) {
    err.innerHTML = "âŒ æœªè¼¸å…¥æœ‰æ•ˆ SQL æŒ‡ä»¤ï¼ˆè¨»é‡‹å·²è¢«å¿½ç•¥ï¼‰";
    return;
  }

  // åˆ¤æ–·æŒ‡ä»¤é¡å‹
  if (/^SELECT/i.test(sql)) {
    handleSelect(sql);
  } else if (/^INSERT/i.test(sql)) {
    handleInsert(sql);
  } else if (/^UPDATE/i.test(sql)) {
    handleUpdate(sql);
  } else if (/^DELETE/i.test(sql)) {
    handleDelete(sql);
  } else {
    err.innerHTML = "âŒ åªæ”¯æ´ SELECT / INSERT / UPDATE / DELETE æŒ‡ä»¤ï¼ˆDSE ç¯„åœå…§ï¼‰";
  }
}

// ====================== è™•ç† SELECT æŸ¥è©¢ ======================
function handleSelect(sql) {
  let err = document.getElementById("errorArea");
  let res = document.getElementById("resultArea");

  try {
    // åŸºç¤æª¢æŸ¥
    if (!sql.match(/FROM\s+(\w+)/i)) {
      throw new Error("ç¼ºå°‘ FROM é—œéµå­—ï¼Œå¿…é ˆæŒ‡å®šè¡¨æ ¼ï¼ˆFROM singersï¼‰");
    }
    if (sql.match(/FROM\s+(\w+)/i)[1].toLowerCase() !== "singers") {
      throw new Error("æœ¬æ•¸æ“šåº«åªæœ‰ä¸€å€‹è¡¨æ ¼ï¼šsingers");
    }

    // è§£æ SELECT æ¬„ç›®
    let selectPart = sql.split(/FROM/i)[0].replace(/SELECT/i, "").trim();
    if (!selectPart) {
      throw new Error("SELECT å¾Œå¿…é ˆæŒ‡å®šæ¬„ç›®ï¼Œä¾‹å¦‚ SELECT è—å FROM singers");
    }
    let wantedCols = selectPart.split(",").map(s => s.trim());
    let invalidCols = wantedCols.filter(c => 
      !c.includes("COUNT(") && c !== "*" && !columns.includes(c.split(" AS ")[0].trim().replace("DISTINCT ", ""))
    );
    if (invalidCols.length > 0) {
      throw new Error(`æ¬„ç›®ã€Œ${invalidCols[0]}ã€ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥æ‹¼å¯«`);
    }

    // è§£æ WHERE æ¢ä»¶
    let whereExp = null;
    if (/\bWHERE\b/i.test(sql)) {
      let wherePart = sql.split(/WHERE/i)[1].split(/\b(ORDER BY|GROUP BY|LIMIT)\b/i)[0].trim();
      if (!wherePart) {
        throw new Error("WHERE å¾Œå¿…é ˆè·Ÿéš¨æ¢ä»¶ï¼Œä¾‹å¦‚ WHERE æ€§åˆ¥='å¥³'");
      }
      whereExp = wherePart;
    }

    // è§£æ ORDER BY
    let orderBy = null;
    if (/\bORDER BY\b/i.test(sql)) {
      let orderPart = sql.split(/ORDER BY/i)[1].split(/\b(LIMIT|GROUP BY)\b/i)[0].trim();
      if (!orderPart) {
        throw new Error("ORDER BY å¾Œå¿…é ˆæŒ‡å®šæ¬„ç›®ï¼Œä¾‹å¦‚ ORDER BY å‡ºé“å¹´ä»½ DESC");
      }
      let [col, dir = "ASC"] = orderPart.split(/\s+/);
      if (!columns.includes(col)) {
        throw new Error(`æ’åºæ¬„ç›®ã€Œ${col}ã€ä¸å­˜åœ¨`);
      }
      orderBy = { column: col, direction: dir.toUpperCase() };
    }

    // è§£æ LIMIT
    let limit = null;
    if (/\bLIMIT\b/i.test(sql)) {
      let limitPart = sql.split(/LIMIT/i)[1].trim();
      if (!limitPart || isNaN(limitPart)) {
        throw new Error("LIMIT å¾Œå¿…é ˆè·Ÿéš¨æ•¸å­—ï¼Œä¾‹å¦‚ LIMIT 5");
      }
      limit = parseInt(limitPart);
    }

    // è§£æ GROUP BY
    let groupBy = null;
    if (/\bGROUP BY\b/i.test(sql)) {
      let groupPart = sql.split(/GROUP BY/i)[1].split(/\b(ORDER BY|LIMIT)\b/i)[0].trim();
      if (!groupPart) {
        throw new Error("GROUP BY å¾Œå¿…é ˆæŒ‡å®šæ¬„ç›®ï¼Œä¾‹å¦‚ GROUP BY æ‰€å±¬å¹³å°/å» ç‰Œ");
      }
      if (!columns.includes(groupPart)) {
        throw new Error(`åˆ†çµ„æ¬„ç›®ã€Œ${groupPart}ã€ä¸å­˜åœ¨`);
      }
      groupBy = groupPart;
    }

    // åŸ·è¡ŒæŸ¥è©¢
    let result = executeSelect(wantedCols, whereExp, orderBy, limit, groupBy);
    displayResult(result, wantedCols, groupBy);
    err.innerHTML = `âœ… æŸ¥è©¢æˆåŠŸï¼Œè¿”å› ${result.length} ç­†è¨˜éŒ„`;
  } catch (e) {
    err.innerHTML = `âŒ æŸ¥è©¢éŒ¯èª¤ï¼š${e.message}`;
  }
}

// ====================== åŸ·è¡Œ SELECT æŸ¥è©¢ ======================
function executeSelect(wantedCols, whereExp, orderBy, limit, groupBy) {
  // è½‰æ›ç‚ºç‰©ä»¶é™£åˆ—
  let data = dbData.map(row => Object.fromEntries(columns.map((c,i)=>[c,row[i]])));

  // æ‡‰ç”¨ WHERE éæ¿¾
  if (whereExp) {
    data = data.filter(row => {
      let expr = whereExp.replace(/(\w+)/g, (_, key) => 
        columns.includes(key) ? `row['${key}']` : _
      );
      return eval(expr);
    });
  }

  // æ‡‰ç”¨ GROUP BY èˆ‡ COUNT
  if (groupBy) {
    const groups = {};
    data.forEach(row => {
      const key = row[groupBy];
      if (!groups[key]) groups[key] = [];
      groups[key].push(row);
    });
    data = Object.entries(groups).map(([key, rows]) => ({
      [groupBy]: key,
      "COUNT(*)": rows.length
    }));
  }

  // æ‡‰ç”¨ ORDER BY
  if (orderBy) {
    data.sort((a, b) => {
      let valA = a[orderBy.column];
      let valB = b[orderBy.column];
      if (valA === null) return 1;
      if (valB === null) return -1;
      if (typeof valA === 'number') {
        return orderBy.direction === "ASC" ? valA - valB : valB - valA;
      } else {
        return orderBy.direction === "ASC" 
          ? String(valA).localeCompare(String(valB))
          : String(valB).localeCompare(String(valA));
      }
    });
  }

  // æ‡‰ç”¨ LIMIT
  if (limit) {
    data = data.slice(0, limit);
  }

  // è™•ç† DISTINCT
  if (wantedCols.some(c => c.startsWith("DISTINCT "))) {
    let distinctCol = wantedCols.find(c => c.startsWith("DISTINCT ")).replace("DISTINCT ", "").trim();
    let uniqueValues = [...new Set(data.map(row => row[distinctCol]))];
    data = uniqueValues.map(val => ({ [distinctCol]: val }));
  }

  return data;
}

// ====================== è™•ç† INSERT æ–°å¢ ======================
function handleInsert(sql) {
  let err = document.getElementById("errorArea");
  let res = document.getElementById("resultArea");

  try {
    // è§£æ INSERT
    let match = sql.match(/INSERT INTO singers \((.*?)\) VALUES \((.*?)\)/i);
    if (!match) {
      throw new Error("INSERT èªæ³•éŒ¯èª¤ï¼Œæ­£ç¢ºæ ¼å¼ï¼šINSERT INTO singers (æ¬„ç›®1, æ¬„ç›®2) VALUES ('å€¼1', 'å€¼2')");
    }

    let cols = match[1].split(",").map(c => c.trim());
    let vals = match[2].split(",").map(v => {
      v = v.trim();
      // ç§»é™¤å¼•è™Ÿ
      if ((v.startsWith("'") && v.endsWith("'")) || (v.startsWith('"') && v.endsWith('"'))) {
        return v.substring(1, v.length-1);
      }
      // æ•¸å­—è½‰æ›
      if (!isNaN(v)) return parseInt(v);
      // NULL è™•ç†
      if (v.toUpperCase() === 'NULL') return null;
      return v;
    });

    // æª¢æŸ¥æ¬„ç›®åˆæ³•æ€§
    let invalidCols = cols.filter(c => !columns.includes(c));
    if (invalidCols.length > 0) {
      throw new Error(`æ¬„ç›®ã€Œ${invalidCols[0]}ã€ä¸å­˜åœ¨`);
    }

    // å»ºç«‹æ–°è¨˜éŒ„
    let newRow = new Array(columns.length).fill(null);
    cols.forEach((col, i) => {
      let idx = columns.indexOf(col);
      newRow[idx] = vals[i];
    });

    // æª¢æŸ¥ä¸»éµï¼ˆè—åï¼‰æ˜¯å¦å­˜åœ¨
    if (!newRow[0]) {
      throw new Error("å¿…é ˆæŒ‡å®šä¸»éµã€Œè—åã€");
    }
    if (dbData.some(row => row[0] === newRow[0])) {
      throw new Error(`è—åã€Œ${newRow[0]}ã€å·²å­˜åœ¨ï¼Œä¸»éµä¸èƒ½é‡è¤‡`);
    }

    // æ–°å¢è¨˜éŒ„
    dbData.push(newRow);
    res.innerHTML = `<p class='success'>âœ… æˆåŠŸæ–°å¢ 1 ç­†è¨˜éŒ„ï¼šè—åã€Œ${newRow[0]}ã€</p>`;
  } catch (e) {
    err.innerHTML = `âŒ æ–°å¢éŒ¯èª¤ï¼š${e.message}`;
  }
}

// ====================== è™•ç† UPDATE ä¿®æ”¹ ======================
function handleUpdate(sql) {
  let err = document.getElementById("errorArea");
  let res = document.getElementById("resultArea");

  try {
    // è§£æ UPDATE
    let match = sql.match(/UPDATE singers SET (.*?) WHERE (.*)/i);
    if (!match) {
      throw new Error("UPDATE èªæ³•éŒ¯èª¤ï¼Œæ­£ç¢ºæ ¼å¼ï¼šUPDATE singers SET æ¬„ç›®='å€¼' WHERE æ¢ä»¶");
    }

    let setPart = match[1];
    let wherePart = match[2];

    // è§£æ SET
    let setPairs = setPart.split(",").map(p => p.trim().split("="));
    let updates = {};
    setPairs.forEach(([col, val]) => {
      col = col.trim();
      val = val.trim();
      if (!columns.includes(col)) {
        throw new Error(`æ¬„ç›®ã€Œ${col}ã€ä¸å­˜åœ¨`);
      }
      // è™•ç†å€¼
      if ((val.startsWith("'") && val.endsWith("'")) || (val.startsWith('"') && val.endsWith('"'))) {
        val = val.substring(1, val.length-1);
      } else if (!isNaN(val)) {
        val = parseInt(val);
      } else if (val.toUpperCase() === 'NULL') {
        val = null;
      }
      updates[col] = val;
    });

    // è§£æ WHERE
    let whereExp = wherePart;
    if (!whereExp) {
      throw new Error("å¿…é ˆæŒ‡å®š WHERE æ¢ä»¶ï¼Œå¦å‰‡æœƒä¿®æ”¹æ‰€æœ‰è¨˜éŒ„");
    }

    // åŸ·è¡Œæ›´æ–°
    let count = 0;
    dbData = dbData.map(row => {
      let rowObj = Object.fromEntries(columns.map((c,i)=>[c,row[i]]));
      let expr = whereExp.replace(/(\w+)/g, (_, key) => 
        columns.includes(key) ? `rowObj['${key}']` : _
      );
      if (eval(expr)) {
        count++;
        for (let col in updates) {
          let idx = columns.indexOf(col);
          row[idx] = updates[col];
        }
      }
      return row;
    });

    if (count === 0) {
      res.innerHTML = "<p class='success'>â„¹ï¸ æ²’æœ‰è¨˜éŒ„ç¬¦åˆ WHERE æ¢ä»¶ï¼Œæ•¸æ“šæœªè¢«ä¿®æ”¹</p>";
    } else {
      res.innerHTML = `<p class='success'>âœ… æˆåŠŸä¿®æ”¹ ${count} ç­†è¨˜éŒ„</p>`;
    }
  } catch (e) {
    err.innerHTML = `âŒ ä¿®æ”¹éŒ¯èª¤ï¼š${e.message}`;
  }
}

// ====================== è™•ç† DELETE åˆªé™¤ ======================
function handleDelete(sql) {
  let err = document.getElementById("errorArea");
  let res = document.getElementById("resultArea");

  try {
    // è§£æ DELETE
    let match = sql.match(/DELETE FROM singers WHERE (.*)/i);
    if (!match) {
      throw new Error("DELETE èªæ³•éŒ¯èª¤ï¼Œæ­£ç¢ºæ ¼å¼ï¼šDELETE FROM singers WHERE æ¢ä»¶");
    }

    let whereExp = match[1];
    if (!whereExp) {
      throw new Error("å¿…é ˆæŒ‡å®š WHERE æ¢ä»¶ï¼Œå¦å‰‡æœƒåˆªé™¤æ‰€æœ‰è¨˜éŒ„");
    }

    // åŸ·è¡Œåˆªé™¤
    let originalCount = dbData.length;
    dbData = dbData.filter(row => {
      let rowObj = Object.fromEntries(columns.map((c,i)=>[c,row[i]]));
      let expr = whereExp.replace(/(\w+)/g, (_, key) => 
        columns.includes(key) ? `rowObj['${key}']` : _
      );
      return !eval(expr);
    });

    let deleted = originalCount - dbData.length;
    if (deleted === 0) {
      res.innerHTML = "<p class='success'>â„¹ï¸ æ²’æœ‰è¨˜éŒ„ç¬¦åˆ WHERE æ¢ä»¶ï¼Œæ•¸æ“šæœªè¢«ä¿®æ”¹</p>";
    } else {
      res.innerHTML = `<p class='success'>âœ… æˆåŠŸåˆªé™¤ ${deleted} ç­†è¨˜éŒ„</p>`;
    }
  } catch (e) {
    err.innerHTML = `âŒ åˆªé™¤éŒ¯èª¤ï¼š${e.message}`;
  }
}

// ====================== é¡¯ç¤ºæŸ¥è©¢çµæœ ======================
function displayResult(result, wantedCols, groupBy) {
  let res = document.getElementById("resultArea");
  if (result.length === 0) {
    res.innerHTML = "<p>ğŸ“Š æŸ¥è©¢çµæœç‚ºç©º</p>";
    return;
  }

  // ç¢ºå®šé¡¯ç¤ºæ¬„ç›®
  let displayCols = wantedCols.includes("*") 
    ? columns 
    : wantedCols.map(c => c.split(" AS ")[0].trim().replace("DISTINCT ", ""));

  // å¦‚æœæ˜¯åˆ†çµ„æŸ¥è©¢ï¼Œèª¿æ•´é¡¯ç¤ºæ¬„ç›®
  if (groupBy) {
    displayCols = [groupBy, "COUNT(*)"];
  }

  // ç”Ÿæˆè¡¨æ ¼
  let html = `<div class="result-table"><table border="1"><tr>`;
  displayCols.forEach(c => {
    let alias = wantedCols.find(col => col.startsWith(c))?.split(" AS ")[1] || c;
    html += `<th>${alias}</th>`;
  });
  html += `</tr>`;
  result.forEach(row => {
    html += `<tr>`;
    displayCols.forEach(c => html += `<td>${row[c] ?? ""}</td>`);
    html += `</tr>`;
  });
  html += `</table></div>`;
  res.innerHTML = html;
}
</script>
</body>
</html>
